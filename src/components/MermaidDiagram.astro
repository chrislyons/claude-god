---
interface Props {
  diagram: string;
}

const { diagram } = Astro.props;
---

<div class="mermaid-wrapper my-8">
  <pre class="mermaid">{diagram}</pre>
</div>

<script>
  // Lazy-load Mermaid only when diagrams exist on the page
  // This saves ~1.5MB on pages without diagrams

  let mermaidModule: typeof import('mermaid') | null = null;
  let themeModule: typeof import('../config/mermaid-theme') | null = null;

  async function loadMermaid() {
    if (!mermaidModule) {
      const [mermaid, theme] = await Promise.all([
        import('mermaid'),
        import('../config/mermaid-theme')
      ]);
      mermaidModule = mermaid;
      themeModule = theme;
    }
    return { mermaid: mermaidModule.default, getMermaidTheme: themeModule!.getMermaidTheme };
  }

  // Initialize Mermaid with current theme
  async function initMermaid() {
    const hasDiagrams = document.querySelector('.mermaid');
    if (!hasDiagrams) return;

    const { mermaid, getMermaidTheme } = await loadMermaid();
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: getMermaidTheme(isDark),
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
      },
      sequence: {
        useMaxWidth: true,
      },
    });

    await mermaid.run();

    // Fix viewBox to include all content (Mermaid sometimes miscalculates)
    document.querySelectorAll('.mermaid-wrapper svg').forEach((svg) => {
      const bbox = (svg as SVGSVGElement).getBBox();
      const padding = 20;
      const newViewBox = `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding * 2} ${bbox.height + padding * 2}`;
      svg.setAttribute('viewBox', newViewBox);

      // Remove explicit width/height to allow CSS to control scaling
      svg.removeAttribute('width');
      svg.removeAttribute('height');
    });
  }

  // Re-render diagrams when theme changes
  async function rerenderMermaid() {
    const hasDiagrams = document.querySelector('.mermaid');
    if (!hasDiagrams || !mermaidModule) return;

    const { mermaid, getMermaidTheme } = await loadMermaid();
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    // Clear existing diagrams
    document.querySelectorAll('.mermaid').forEach((el) => {
      el.removeAttribute('data-processed');
      const svg = el.querySelector('svg');
      if (svg) {
        el.innerHTML = el.getAttribute('data-mermaid-src') || '';
      }
    });

    // Re-initialize with new theme
    mermaid.initialize({
      startOnLoad: false,
      theme: 'base',
      themeVariables: getMermaidTheme(isDark),
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
      },
      sequence: {
        useMaxWidth: true,
      },
    });

    await mermaid.run();

    // Fix viewBox to include all content (Mermaid sometimes miscalculates)
    document.querySelectorAll('.mermaid-wrapper svg').forEach((svg) => {
      const bbox = (svg as SVGSVGElement).getBBox();
      const padding = 20;
      const newViewBox = `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding * 2} ${bbox.height + padding * 2}`;
      svg.setAttribute('viewBox', newViewBox);

      // Remove explicit width/height to allow CSS to control scaling
      svg.removeAttribute('width');
      svg.removeAttribute('height');
    });
  }

  // Initialize on load
  if (typeof window !== 'undefined') {
    // Store original diagram source before first render
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.mermaid').forEach((el) => {
        el.setAttribute('data-mermaid-src', el.textContent || '');
      });
      initMermaid();
    });

    // Watch for theme changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
          rerenderMermaid();
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme'],
    });
  }
</script>

<style>
  .mermaid {
    background-color: transparent;
    border: none;
    padding: 0;
  }

  .mermaid-wrapper {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Make Mermaid SVGs responsive and auto-scale to container */
  .mermaid-wrapper :global(svg) {
    display: block;
    width: 100%;
    height: auto;
    max-width: 100%;
  }
</style>
