---
interface Props {
  guideId: string;
}

import { GUIDES } from '../config/guides';
import BrandHeader from './BrandHeader.astro';

const { guideId } = Astro.props;
const base = import.meta.env.BASE_URL;

// Get all guides as array
const allGuides = Object.entries(GUIDES).map(([id, guide]) => ({
  id,
  ...guide
}));
---

<aside
  class="fixed top-0 left-0 w-sidebar h-screen overflow-y-auto theme-bg lg:block md:hidden"
  role="complementary"
  aria-label="Guide navigation"
>
  <!-- Brand Header at top of sidebar (vertically aligned with navbar) -->
  <div class="h-header flex items-center px-8 theme-border-bottom">
    <BrandHeader />
  </div>

  <!-- Accordion Navigation -->
  <nav aria-label="Guides" class="accordion-nav px-8 pt-4 theme-border-right" style="min-height: calc(100vh - 64px);">
    {allGuides.map(guide => (
      <div class="accordion-section" data-guide-id={guide.id}>
        <!-- Accordion Header -->
        <button
          class:list={[
            "accordion-header w-full flex items-center justify-between px-4 py-3 rounded transition-all text-left font-medium theme-text hover:bg-opacity-10 hover:bg-black",
            { "accordion-active": guide.id === guideId }
          ]}
          data-accordion-toggle={guide.id}
          aria-expanded={guide.id === guideId ? 'true' : 'false'}
          aria-controls={`accordion-content-${guide.id}`}
        >
          <span>{guide.title}</span>
          <svg
            class="accordion-chevron w-4 h-4 transition-transform"
            class:list={{
              'rotate-90': guide.id === guideId
            }}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <!-- Accordion Content -->
        <div
          id={`accordion-content-${guide.id}`}
          class="accordion-content"
          class:list={{
            'hidden': guide.id !== guideId
          }}
        >
          <ul class="list-none p-0 pl-4 mt-2" role="list">
            {guide.navigation.map(item => {
              const isHashLink = guide.id === guideId;
              // Always use absolute paths with /claude-god/ prefix to prevent relative path navigation
              const href = isHashLink
                ? `#${item.id}`
                : `/claude-god${guide.route}#${item.id}`;

              return (
                <li class="my-1">
                  <a
                    href={href}
                    class="block px-4 py-2 rounded transition-all text-sm no-underline nav-link theme-text opacity-80 hover:opacity-100"
                    data-nav-link={item.id}
                    aria-current={false}
                  >
                    {item.label}
                  </a>
                </li>
              );
            })}
          </ul>
        </div>
      </div>
    ))}
  </nav>
</aside>
